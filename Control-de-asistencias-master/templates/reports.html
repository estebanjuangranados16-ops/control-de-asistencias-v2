<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reportes de Asistencia</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f8f9fa; }
        
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1rem; }
        .header h1 { text-align: center; }
        .datetime { text-align: center; font-size: 0.9rem; margin-top: 0.5rem; }
        
        .container { max-width: 1400px; margin: 0 auto; padding: 2rem; }
        .controls { display: flex; gap: 1rem; margin-bottom: 2rem; flex-wrap: wrap; align-items: center; }
        .btn { padding: 0.75rem 1.5rem; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; text-decoration: none; display: inline-block; }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-info { background: #17a2b8; color: white; }
        
        .filters { background: white; padding: 1.5rem; border-radius: 12px; margin-bottom: 2rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .filter-row { display: flex; gap: 1rem; align-items: end; flex-wrap: wrap; }
        .filter-group { display: flex; flex-direction: column; }
        .filter-group label { font-weight: 500; margin-bottom: 0.5rem; }
        .filter-control { padding: 0.5rem; border: 1px solid #ced4da; border-radius: 6px; }
        
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
        .stat-card { background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); text-align: center; }
        .stat-number { font-size: 2rem; font-weight: bold; color: #007bff; }
        .stat-label { color: #6c757d; font-size: 0.9rem; }
        
        .report-table { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .table { width: 100%; border-collapse: collapse; }
        .table th { background: #f8f9fa; padding: 1rem; text-align: left; font-weight: 600; border-bottom: 2px solid #dee2e6; }
        .table td { padding: 1rem; border-bottom: 1px solid #dee2e6; }
        .table tr:hover { background: #f8f9fa; }
        
        .badge { padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.8rem; font-weight: 500; }
        .badge-success { background: #d4edda; color: #155724; }
        .badge-warning { background: #fff3cd; color: #856404; }
        .badge-danger { background: #f8d7da; color: #721c24; }
        .badge-info { background: #d1ecf1; color: #0c5460; }
        
        .loading { text-align: center; padding: 3rem; color: #6c757d; }
        .empty-state { text-align: center; padding: 3rem; color: #6c757d; }
    </style>
</head>
<body>
    <div class="header">
        <h1>üìä Reportes de Asistencia</h1>
        <div class="datetime" id="currentDateTime"></div>
    </div>

    <div class="container">
        <div class="controls">
            <a href="/" class="btn btn-secondary">‚Üê Volver al Dashboard</a>
            <button class="btn btn-success" onclick="exportToExcel()">üìä Exportar Excel</button>
            <button class="btn btn-info" onclick="generatePDF()">üìÑ Generar PDF</button>
        </div>

        <div class="filters">
            <div class="filter-row">
                <div class="filter-group">
                    <label>Fecha Inicio</label>
                    <input type="date" class="filter-control" id="startDate">
                </div>
                <div class="filter-group">
                    <label>Fecha Fin</label>
                    <input type="date" class="filter-control" id="endDate">
                </div>
                <div class="filter-group">
                    <label>Empleado</label>
                    <select class="filter-control" id="employeeFilter">
                        <option value="">Todos los empleados</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Tipo de Reporte</label>
                    <select class="filter-control" id="reportType">
                        <option value="daily">Diario</option>
                        <option value="summary">Resumen</option>
                        <option value="hours">Horas Trabajadas</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>&nbsp;</label>
                    <button class="btn btn-primary" onclick="generateReport()">üîç Generar Reporte</button>
                </div>
            </div>
        </div>

        <div class="stats-grid" id="statsGrid">
            <div class="stat-card">
                <div class="stat-number" id="totalRecords">0</div>
                <div class="stat-label">Total Registros</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalEmployees">0</div>
                <div class="stat-label">Empleados Activos</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="avgHours">0</div>
                <div class="stat-label">Promedio Horas/D√≠a</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="lateArrivals">0</div>
                <div class="stat-label">Llegadas Tard√≠as</div>
            </div>
        </div>

        <div class="report-table">
            <table class="table">
                <thead id="tableHeader">
                    <tr>
                        <th>Empleado</th>
                        <th>Fecha</th>
                        <th>Entrada</th>
                        <th>Salida</th>
                        <th>Horas Trabajadas</th>
                        <th>Estado</th>
                    </tr>
                </thead>
                <tbody id="reportBody">
                    <tr>
                        <td colspan="6" class="loading">Selecciona fechas y genera un reporte</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        let currentReportData = [];

        function updateDateTime() {
            const now = new Date();
            const dateStr = now.toLocaleDateString('es-ES', {
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric'
            });
            const timeStr = now.toLocaleTimeString('es-ES', {
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit'
            });
            document.getElementById('currentDateTime').textContent = `${dateStr} - ${timeStr}`;
        }

        function initializeDates() {
            const today = new Date();
            const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
            
            document.getElementById('startDate').value = weekAgo.toISOString().split('T')[0];
            document.getElementById('endDate').value = today.toISOString().split('T')[0];
        }

        function loadEmployees() {
            fetch('/api/employees')
                .then(response => response.json())
                .then(employees => {
                    const select = document.getElementById('employeeFilter');
                    select.innerHTML = '<option value="">Todos los empleados</option>';
                    
                    employees.forEach(emp => {
                        if (emp.active) {
                            const option = document.createElement('option');
                            option.value = emp.employee_id;
                            option.textContent = emp.name;
                            select.appendChild(option);
                        }
                    });
                });
        }

        function generateReport() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const employeeId = document.getElementById('employeeFilter').value;
            const reportType = document.getElementById('reportType').value;

            if (!startDate || !endDate) {
                alert('Por favor selecciona las fechas');
                return;
            }

            document.getElementById('reportBody').innerHTML = '<tr><td colspan="6" class="loading">Generando reporte...</td></tr>';

            const params = new URLSearchParams({
                start_date: startDate,
                end_date: endDate,
                employee_id: employeeId,
                report_type: reportType
            });

            fetch(`/api/reports?${params}`)
                .then(response => response.json())
                .then(data => {
                    currentReportData = data;
                    displayReport(data);
                    updateStats(data);
                })
                .catch(error => {
                    document.getElementById('reportBody').innerHTML = '<tr><td colspan="6" class="empty-state">Error al generar reporte</td></tr>';
                });
        }

        function displayReport(data) {
            const tbody = document.getElementById('reportBody');
            
            if (!data.records || data.records.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="empty-state">No hay registros en el per√≠odo seleccionado</td></tr>';
                return;
            }

            tbody.innerHTML = data.records.map(record => `
                <tr>
                    <td><strong>${record.employee_name}</strong></td>
                    <td>${new Date(record.date).toLocaleDateString('es-ES')}</td>
                    <td>${record.entry_time || '-'}</td>
                    <td>${record.exit_time || '-'}</td>
                    <td>${record.hours_worked || '0.0'} hrs</td>
                    <td>
                        <span class="badge ${getBadgeClass(record.status)}">
                            ${getStatusText(record.status)}
                        </span>
                    </td>
                </tr>
            `).join('');
        }

        function updateStats(data) {
            document.getElementById('totalRecords').textContent = data.stats.total_records || 0;
            document.getElementById('totalEmployees').textContent = data.stats.total_employees || 0;
            document.getElementById('avgHours').textContent = (data.stats.avg_hours || 0).toFixed(1);
            document.getElementById('lateArrivals').textContent = data.stats.late_arrivals || 0;
        }

        function getBadgeClass(status) {
            switch(status) {
                case 'complete': return 'badge-success';
                case 'incomplete': return 'badge-warning';
                case 'late': return 'badge-danger';
                case 'absent': return 'badge-danger';
                default: return 'badge-info';
            }
        }

        function getStatusText(status) {
            switch(status) {
                case 'complete': return 'Completo';
                case 'incomplete': return 'Incompleto';
                case 'late': return 'Tard√≠o';
                case 'absent': return 'Ausente';
                default: return 'Normal';
            }
        }

        function exportToExcel() {
            if (!currentReportData.records || currentReportData.records.length === 0) {
                alert('Genera un reporte primero');
                return;
            }

            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            const params = new URLSearchParams({
                start_date: startDate,
                end_date: endDate,
                employee_id: document.getElementById('employeeFilter').value,
                format: 'excel'
            });

            window.open(`/api/reports/export?${params}`, '_blank');
        }

        function generatePDF() {
            if (!currentReportData.records || currentReportData.records.length === 0) {
                alert('Genera un reporte primero');
                return;
            }

            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            const params = new URLSearchParams({
                start_date: startDate,
                end_date: endDate,
                employee_id: document.getElementById('employeeFilter').value,
                format: 'pdf'
            });

            window.open(`/api/reports/export?${params}`, '_blank');
        }

        // Inicializar
        updateDateTime();
        setInterval(updateDateTime, 1000);
        initializeDates();
        loadEmployees();
    </script>
</body>
</html>